/** * @module Chat * @method chatcontrol  -- 聊天UI构建 * @method chatroom  -- 文本消息UI * @method img  -- 图片消息UI * @method audio  -- 语音消息UI * @method pusher  -- 图文消息UI * @method imgalert  -- 弹出层UI */(function(mui) {	var Chat = function() {		this.audioArray = [];	};	Chat.prototype = {		chatroom: function(cfg) {			var defaultcfg = {				self: 'no', //是否是自己发言				type: 'text', //发言类型 text image audio				imgsrc: '../img/account-picture.png', //如果是图片类型的消息，图片信息URL				msg: '我是一条信息',				pic: '../img/account-picture.png', //发言人头像url				showTime:'db',				userinfo: {},				callback:null,				insertBefore:false			}			var cfg = mui.extend(defaultcfg, cfg || {});			var imgurl;			cfg.userinfo.portraitUri == 'undefined' || cfg.userinfo.portraitUri == undefined? imgurl = rongYun.defaultsAvatar : imgurl = cfg.userinfo.portraitUri;			var boundingBox = document.createElement('div');			boundingBox.className = cfg.self === "no" ? "fix  Chat_l mt2rem" : "fix Chat_r mt2rem";			boundingBox.setAttribute('data-time',cfg.time);			var that = this;			var message,portraitUri;			var nikNameClass = cfg.self === "no" ? "tl" : "tr";			boundingBox.innerHTML =			    '<div class="Chat_time '+cfg.showTime+'">'+			    	'<span class="Btn_20 Btn_gray Btn_radiusI">' + new Date(parseInt(cfg.time, 10)).Format("yyyy-MM-dd hh:mm") + '</span>' +			    '</div>'+				'<div class="Chat_nicknm '+nikNameClass+'">'+cfg.userinfo.name+'</div>'+				'<div class="mr1rem l">' +				'<img src="' + imgurl + '" width="30" height="30" alt="" style="border-radius:15px; overflow:hidden" />' +				'</div>' +				'<div class="ovh">' +				'<span class="talk_r talk_gray">' +				cfg.msg +				'</span>' +				'</div>';			if(cfg.insertBefore){				document.getElementById('chatRoom').insertBefore(boundingBox, document.getElementById('chatRoom').children[0]);			}else{				document.getElementById('chatRoom').appendChild(boundingBox);			}						cfg.callback && cfg.callback();		},		chatcontrol: function(cfg, userinfo) {			var that = this;			var MIN_SOUND_TIME = 800;			var defaultcfg = {				type: 'text' //文本还是图片还是音频 text,image,audio			};			var chatcontrolArea = document.createElement('footer');			chatcontrolArea.clasName = 'foot_area';			chatcontrolArea.innerHTML =				'<div class="footer-left" id="footer-left">' +				'<i id="msg-image" class="mui-icon mui-icon-camera C_3" style="font-size: 28px;"></i>' +				'</div>' +				'<div class="footer-center">' +				'<textarea id="msg-text" type="text" class="input-text"></textarea>' +				'<button id="msg-sound" type="button" class="input-sound" style="display: none;">按住说话</button>' +				'</div>' +				'<label for="" class="footer-right">' +				'<i id="msg-type" class="mui-icon mui-icon-mic C_3"></i>' +				'</label>'			document.body.appendChild(chatcontrolArea);						var doc = window.document;			var ui = {				body: doc.querySelector('body'),				footer: doc.querySelector('footer'),				footerLeft: doc.querySelector('.footer-left'),				footerRight: doc.querySelector('.footer-right'),				btnMsgType: doc.querySelector('#msg-type'),				boxMsgText: doc.querySelector('#msg-text'),				boxMsgSound: doc.querySelector('#msg-sound'),				btnMsgImage: doc.querySelector('#msg-image'),				content: doc.querySelector('.mui-content'),				boxSoundAlert: doc.querySelector('#sound-alert'),			}			var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;			function msgTextFocus() {				ui.boxMsgText.focus();				setTimeout(function() {					ui.boxMsgText.focus();				}, 150);			}			ui.boxMsgSound.addEventListener("touchstart", function(e) {				//console.log("start....");				e.preventDefault();			});			//解决长按“发送”按钮，导致键盘关闭的问题；			ui.footerRight.addEventListener('touchstart', function(event) {				if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {					msgTextFocus();					event.preventDefault();				}			});			//解决长按“发送”按钮，导致键盘关闭的问题；			ui.footerRight.addEventListener('touchmove', function(event) {				if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {					msgTextFocus();					event.preventDefault();				}			});			ui.boxMsgText.addEventListener('input', function(event) {				ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');				ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');			});			var focus = false;			SCROLLY=50;			TIMER_NAME=300; // focus事件中500ms后进行判断			MAX_SCROLL=99999; // 越大越好			if(mui.os.ios) {				ui.boxMsgText.addEventListener('focus',function(){					setTimeout(function() {				      if(window.scrollY < SCROLLY) {				        window.scrollTo(0, MAX_SCROLL);				      }				    }, 300);				},false)			}			ui.boxMsgText.addEventListener('tap', function(event) {				document.body.onscroll = function(){					return false;				};								ui.boxMsgText.focus();				setTimeout(function() {					ui.boxMsgText.focus();				}, 200);				focus = true;				setTimeout(function () {					focus = false;				},1000);				event.detail.gesture.preventDefault();			}, false);			ui.footerRight.addEventListener('release', function(event) {								if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {					ui.boxMsgText.focus();					setTimeout(function() {						ui.boxMsgText.focus();					}, 150);					rongSentMessage.text(ui.boxMsgText.value, cfg.ConversationType, cfg.targetId, userinfo);					ui.boxMsgText.value = '';					mui.trigger(ui.boxMsgText, 'input', null);				} else if(ui.btnMsgType.classList.contains('mui-icon-mic')) {					ui.btnMsgType.classList.add('mui-icon-compose');					ui.btnMsgType.classList.remove('mui-icon-mic');					ui.boxMsgText.style.display = 'none';					ui.boxMsgSound.style.display = 'block';					ui.boxMsgText.blur();					document.body.focus();				} else if(ui.btnMsgType.classList.contains('mui-icon-compose')) {					ui.btnMsgType.classList.add('mui-icon-mic');					ui.btnMsgType.classList.remove('mui-icon-compose');					ui.boxMsgSound.style.display = 'none';					ui.boxMsgText.style.display = 'block';					//showKeyboard();					ui.boxMsgText.focus();					setTimeout(function() {						ui.boxMsgText.focus();					}, 150);				}			}, false);			var setSoundAlertVisable = function(show) {				if(show) {					ui.boxSoundAlert.style.display = 'block';					ui.boxSoundAlert.style.opacity = 1;				} else {					ui.boxSoundAlert.style.opacity = 0;					//fadeOut 完成再真正隐藏					setTimeout(function() {						ui.boxSoundAlert.style.display = 'none';					}, 200);				}			};			var recordCancel = false;			var recorder = null;			var currentTime = null;			var audio_tips = document.getElementById("audio_tips");			var startTimestamp = null;			var stopTimestamp = null;			var stopTimer = null;			ui.boxMsgSound.addEventListener('hold', function(event) {				var iosPP = 'unsupported';				var androidPP = false;				if (mui.os.android) {					androidPP = plus.istudy.checkPermission("RECORD");				}else{					iosPP = plus.navigator.checkPermission("RECORD");				}				if((iosPP== 'denied' || iosPP== 'unknown') && !androidPP){					mui.toast("录音权限没有开启，请重新设置权限");									}else{					if(iosPP== 'undetermined' || iosPP== 'authorized' || androidPP){					recordCancel = false;					if(stopTimer) clearTimeout(stopTimer);					audio_tips.innerHTML = "手指上划，取消发送";					ui.boxSoundAlert.classList.remove('rprogress-sigh');					setSoundAlertVisable(true);					recorder = plus.audio.getRecorder();					if(recorder == null) {						plus.nativeUI.toast("不能获取录音对象");						return;					}					startTimestamp = (new Date()).getTime();					recorder.record({filename: "_doc/audio/"}, function(path) {						//如果取消录制为TRUE则取消录制						if (recordCancel || iosPP== 'undetermined' ) return;						var absUrl = plus.io.convertLocalFileSystemURL(path)						var usif = userinfo;						plus.io.resolveLocalFileSystemURL(path, function(entry) {							// 可通过entry对象操作test.html文件 							entry.file(function(file) {								var fileReader = new plus.io.FileReader();								fileReader.onloadend = function(evt) {									var imgMessage = evt.target.result.split(",");	//								var duration = Math.round(imgMessage[1].length / 1024);									var fullPath = path;									if(mui.os.android){										fullPath = entry.fullPath;									}									rongSentMessage.Audio(imgMessage[1],cfg.ConversationType,cfg.targetId,currentTime,mui.extend(usif,{localSent:true}),fullPath);																	}								fileReader.readAsDataURL(file);							});						}, function(e) {							alert("Resolve file URL failed: " + e.message);						});						}, function(e) {						plus.nativeUI.toast("录音时出现异常: " + e.message);					});				}								}				//如果权限开启，或者权限							}, false);			//按住发语音时，上下移动可以取消语音，这是滑动事件，需要配合release事件一起使用			ui.body.addEventListener('drag', function(event) {				if (Math.abs(event.detail.deltaY) > 50) {					//如果取消发送为false					if (!recordCancel) {						//设置为true						recordCancel = true;						//设置标题为红色						if (!audio_tips.classList.contains("cancel")) {							audio_tips.classList.add("cancel");						}						audio_tips.innerHTML = "松开手指，取消发送";					}				} else {					if (recordCancel) {						recordCancel = false;						if (audio_tips.classList.contains("cancel")) {							audio_tips.classList.remove("cancel");						}						audio_tips.innerHTML = "手指上划，取消发送";					}				}			}, false);			ui.boxMsgSound.addEventListener('release', function(event) {				//console.log('release');								if(audio_tips.classList.contains("cancel")) {					audio_tips.classList.remove("cancel");					audio_tips.innerHTML = "手指上划，取消发送";				}				//				stopTimestamp = (new Date()).getTime();				if(stopTimestamp - startTimestamp < MIN_SOUND_TIME) {					audio_tips.innerHTML = "录音时间太短";					ui.boxSoundAlert.classList.add('rprogress-sigh');					recordCancel = true;					stopTimer = setTimeout(function() {						setSoundAlertVisable(false);					}, 800);				} else {					currentTime = Math.round((stopTimestamp - startTimestamp)/1000);					setSoundAlertVisable(false);				}				recorder.stop();			}, false);						document.getElementById('mui-content').addEventListener('hold',function (event) {				ui.boxMsgText.blur();			})			//相机添加事件			document.getElementById('footer-left').addEventListener('tap', function(event) {				var btnArray = [{					title: "拍照"				}, {					title: "从相册选择"				}];				plus.nativeUI.actionSheet({					title: "选择照片",					cancel: "取消",					buttons: btnArray				}, function(e) {					var index = e.index;					switch(index) {						case 0:							break;						case 1:							var iosPP = 'unsupported';							var androidPP = false;							if (mui.os.android) {								androidPP = plus.istudy.checkPermission("CAMERA");							}else{								iosPP = plus.navigator.checkPermission("CAMERA");							}							if( (iosPP== 'denied' || iosPP== 'unknown') && !androidPP){								mui.toast("照相机权限没有开启，请重新设置权限");							}else{								var cmr = plus.camera.getCamera();								cmr.captureImage(function(path) {									plus.io.resolveLocalFileSystemURL(path, function(entry) {										// 可通过entry对象操作test.html文件 										qiniu.getTempBucketToken({}, function(data) {											token = data.result.token;											var fullPath = path;											if(mui.os.android){												fullPath = entry.fullPath;											}											rongSentMessage.img(cfg.ConversationType,cfg.targetId,token,fullPath,userinfo);										}, function(errorMsg) {											alert('token err= ' + errorMsg);										});									}, function(e) {										alert("Resolve file URL failed: " + e.message);									});																	},function(error){									console.log(error);								});							}														break;						case 2:							var iosPP = 'unsupported';							var androidPP = false;							if (mui.os.android) {								androidPP = plus.istudy.checkPermission("GALLERY");							}else{								iosPP = plus.navigator.checkPermission("GALLERY");							}							if((iosPP== 'denied' || iosPP== 'unknown') && !androidPP){								mui.toast("相册权限没有开启，请重新设置权限");							}else{								plus.gallery.pick(function(path) {									plus.io.resolveLocalFileSystemURL(path, function(entry) {										// 可通过entry对象操作test.html文件 										qiniu.getTempBucketToken({}, function(data) {											token = data.result.token;											var fullPath = path;											if(mui.os.android){												fullPath = entry.fullPath;											}											rongSentMessage.img(cfg.ConversationType,cfg.targetId,token,fullPath,userinfo);										}, function(errorMsg) {											alert('token err= ' + errorMsg);										});									}, function(e) {										alert("Resolve file URL failed: " + e.message);									});																	}, function(err) {}, {});							}						break;					}				});			}, false);		},		img: function(cfg) {			var defaultcfg = {				self: 'no', //是否是自己发言				thumBnail:null,				largeUrl:null,				userinfo: {},				insertBefore:false			}			var cfg = mui.extend(defaultcfg, cfg);			var imgurl = cfg.localUrl;			var boundingBox = document.createElement('div');			boundingBox.className = cfg.self === "no" ? "fix  Chat_l mt2rem" : "fix Chat_r mt2rem";			boundingBox.setAttribute('data-time',cfg.time);			var nikNameClass = cfg.self === "no" ? "tl" : "tr";			var that = this;			var imgBtn = 'imgBtn_'+ new Date().getTime().toString();				boundingBox.innerHTML =				'<div class="Chat_time '+cfg.showTime+'">'+			    	'<span class="Btn_20 Btn_gray Btn_radiusI">' + new Date(parseInt(cfg.time, 10)).Format("yyyy-MM-dd hh:mm") + '</span>' +			    '</div>'+				'<div class="Chat_nicknm '+nikNameClass+'">'+cfg.userinfo.name+'</div>'+				'<div class="mr1rem l">' +				'<img src="' + cfg.userinfo.portraitUri + '" width="30" height="30"  style="overflow:hidden; border-radius:15px;" />' +				'</div>' +				'<div class="ovh">' +				'<img class="chatimg" id="'+imgBtn+'" src="'+ cfg.thumBnail +'" style="max-width:160px; max-height:160px" data-src= "'+cfg.largeUrl+'"/>' +  				'</div>';			//			document.getElementById('chatRoom').appendChild(boundingBox);			if(cfg.insertBefore){				document.getElementById('chatRoom').insertBefore(boundingBox, document.getElementById('chatRoom').children[0]);			}else{				document.getElementById('chatRoom').appendChild(boundingBox);			}						document.getElementById(imgBtn).addEventListener('tap',function(){				that.imgalert({					'imgSrc':this.getAttribute('data-src')				});			});			mui('body').on('tap','.imgalert_area',function(event){				document.body.removeChild(this);			})			cfg.callback && cfg.callback();		},		audio: function(cfg) {			var defaultcfg = {				self: 'no',				duration: 0,				data: '',				userinfo:{},				callback:null,				insertBefore:false			}			var that = this;			var cfg = mui.extend(defaultcfg, cfg);			var boundingBox = document.createElement('div');			boundingBox.className = cfg.self === "no" ? "fix  Chat_l mt2rem" : "fix Chat_r mt2rem";			boundingBox.setAttribute('data-time',cfg.time);			var nikNameClass = cfg.self === "no" ? "tl" : "tr";			var audiid = ('Chat_audio_data' + cfg.time).toString();			boundingBox.innerHTML =				'<div class="Chat_time '+cfg.showTime+'">'+			    	'<span class="Btn_20 Btn_gray Btn_radiusI">' + new Date(parseInt(cfg.time, 10)).Format("yyyy-MM-dd hh:mm") + '</span>' +			    '</div>'+				'<div class="Chat_nicknm '+nikNameClass+'">'+cfg.userinfo.name+'</div>'+				'<div class="l mr1rem">' +				'<img src="' + cfg.userinfo.portraitUri + '" width="30" height="30" alt="" style="border-radius:15px" />' +				'</div>' +				'<div class="ovh">' +				'<span class="talk_r talk_gray talk_audio"  id="' + audiid + '" playing = "" data-path = "'+cfg.absUrl+'" data-audio="' + cfg.data + '">语音 '+ cfg.duration+'\'</span>' +				'</div>'			//document.getElementById('chatRoom').appendChild(boundingBox);			if(cfg.insertBefore){				document.getElementById('chatRoom').insertBefore(boundingBox, document.getElementById('chatRoom').children[0]);			}else{				document.getElementById('chatRoom').appendChild(boundingBox);			}									document.getElementById(audiid).addEventListener('tap', function() {				that.audioArray = rongSentMessage.audioControl(that.audioArray);				this.style.color = "#999";				//如果是本地发送				if(cfg.userinfo.localSent){					var p = plus.audio.createPlayer(cfg.absUrl);					that.audioArray.push(p);					//播放本地音频;					p.play(function() {						p = null;						that.audioArray.splice(0,1);					}, function(e){						//alert(e.message);					});							}else{					that.audioArray = rongSentMessage.audioControl(that.audioArray);						window.plus.im.playVoiceMessage(						cfg.data,						function(){						},						function(){						}					)				}			})			cfg.callback && cfg.callback();		},		pusher: function(cfg) {			var defaultcfg = {				title: '推送标题',				msg: '我是推送的文本，我只能显示三行',				bnUrl: "http://img30.360buyimg.com/da/jfs/t2791/214/3930094447/93429/7d030522/579f0cf9N59cb6b36.jpg",				msgType: 'type',				linkUrl: 'www.m.jd.com',				itemPk: null,				time: '2016年08月08日18:21:23',				insertBefore:false			}			var cfg = mui.extend(defaultcfg, cfg || {});			var currentId = ('chat_current_data_' + new Date().getTime()).toString();			var boundingBox = document.createElement('div');			boundingBox.innerHTML = '<div class="itc_area" id="' + currentId + '">' +				'<div class="itc_mg">' +				'<div class="Btn_20 Btn_gray Btn_radiusI">' + new Date(parseInt(cfg.time, 10)).Format("yyyy-MM-dd hh:mm") + '</div>' +				'</div>' +				'<img src="' + cfg.bnUrl + '" class="itc_img" style="height:11.7rem" alt=""/>' +				'<div class="itc_Tt">' +				cfg.title +				'</div>' +				'<div class="itc_text mui-ellipsis-3">' +				cfg.msg +				'</div>' +				'<div class="tr mt10">' +				'<a href="javascript:" data-href= "' + cfg.linkUrl + '" class="Btn_20 Btn_white Btn_radiusI">' +				'查看详情' +				'</a>' +				'</div>' +				'</div>';			//document.getElementById('pusher_1').appendChild(boundingBox);			if(cfg.insertBefore){				document.getElementById('chatRoom').insertBefore(boundingBox, document.getElementById('chatRoom').children[0]);			}else{				document.getElementById('chatRoom').appendChild(boundingBox);			}			document.getElementById(currentId).addEventListener('tap', function() {				///3链接/4文章消息/5课程/6同学会消息     				var locationInfo = {					3: {						param: {							picUrl: cfg.linkUrl,							title: cfg.title						},						id: 'openlunbopage.html',						url: "../discovery/openlunbopage.html"					},					4: {						param: {							articleId: cfg.msgId,							title: cfg.title						},						id: 'artical_details.html',						url: "artical_details.html"					},					5: {						param: {							courseId: cfg.itemPk						},						id: 'course_detail.html',						url: "../wode/course_detail.html"					},					6: {						param: {							msgId: cfg.msgId,							title: cfg.title						},						id: 'classmatesGroup.html',						url: "classmatesGroup.html"					}				}				mui.openWindow({					id: locationInfo[cfg.msgType].id,					url: locationInfo[cfg.msgType].url,					extras: locationInfo[cfg.msgType].param				});			})		}		,		imgalert:function(cfg){			var defaultcfg = {				imgSrc: 'http://78re52.com1.z0.glb.clouddn.com/resource/gogopher.jpg',			}			var cfg = mui.extend(defaultcfg, cfg || {});			var boundingBox = document.createElement('div');			boundingBox.className = 'imgalert_area'			boundingBox.innerHTML = '<img class="imgalert_img" src="'+cfg.imgSrc+'" />'									+'<span class="vertical"></span>'												document.body.appendChild(boundingBox);		}	}	window.Chat = new Chat;})(mui);(function() {	//置顶直播UI构建	var Live = function() {		this.cfg = {			imUrl: '../img/1_02.png',			title: '直播间',			btnLink: 'http://www.bing.com',			isLive: false,			callback: null		}	};	Live.prototype.liveList = function(cfg) {		var cfg = mui.extend(this.cfg, cfg);		var liveBox = document.createElement('li');		liveBox.className = 'mui-table-view-cell mui-media';		var isLive = cfg.isLive ? 'db' : 'dn';		var liveStr = '<a href="javascript:" data-liveId = "' + cfg.liveId + '">' +			'<img class="mui-media-object mui-pull-left" src="' + cfg.imUrl + '">' +			'<div class="mui-media-body">' +			'<div class="Lc_pd">' +			'<div class="Lc_Tt ell">' + cfg.title + '</div>' +			'<div>&nbsp;</div> ' +			'<p class="C_2 ' + isLive + '">' +			'<span class="icon-video C_2 icon-junior"></span>' +			'<span class="dib vm C_2">' +			'直播中' +			'</span>' +			'</p>' +			'</div>' +			'</div>' +			'</a>' +			'<div class="Lc_absb">' +			'<div class="Lc_mg">' +			'<span class="Btn_20 Btn_orange Btn_radiusI" >' +			'<span class="icon-user icon-junior"></span>' +			'参加' +			'</span>' +			'</div>' +			'</div>'		liveBox.innerHTML = liveStr;		document.getElementById('live_area').appendChild(liveBox);		if(cfg.callback) {			cfg.callback()		}	}	window.Live = new Live;}());